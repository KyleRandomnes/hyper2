---
title: "formula1"
output: html_document
---

```{r setup, include=FALSE}
set.seed(0)
knitr::opts_chunk$set(echo = TRUE)
library("hyper2")
library("magrittr")
```

## Formula 1

Formula 1 racing is an important and prestigious motor sport.  Here I
analyse a series of racing results using the `hyper` package which
implements the Plackett-Luce likelihood function.

Consider the following dataset, taken from Wikipedia:

```{r cars}
f2017 <- read.table("formula1_2017.txt",header=TRUE)
head(f2017)
```

Each row is a driver and each column (after the first) a venue.  We
see that Hamilton, the first row, came second in Australia, first in
China, second in Bahrain, fourth in Russia, and so on.  In the first
column, we see the result from Australia (AUS) in which Hamilton came
second, Vettel first, Bottas third, and so on.  Notation used also
includes six different classes of no-score such as "Ret" for retired,
"WD" for withdrawn, and so on.  I now use bespoke R function
\code{ordertable2supp()}, that translates data of this type into a
log-likelihood.  The function is similar to, but slightly different
from, the analysis in `eurovision.R`.

```{r,applydata}
L2017 <- ordertable2supp(f2017)
head(L2017,3)
```

Above, we see a small part of the Placket-Luce likelihood function for
the 2017 results.  We can find the maximum likelihood estimator by
using the `maxp()` function:


```{r,maxp2017}
mL2017 <- maxp(L2017)
mL2017
dotchart(mL2017,pch=16,main='2017 Formula 1')
dotchart(log(mL2017)[1:23],pch=16,main='2017 Formula 1, log scale')
```

(in the diagram above, we remove the bottom-ranked two players, Resta
and Button, whose estimated strength is zero).

# Likelihood scoring vs points scoring

The championship winning order is determined by a points system: the
winner is awarded 25 points, second place 18 points, and so on.  We
can now check to see how the points total matches up with the
likelihood estimation.

```{r,likelihoodandscore}
points <- f2017$points
names(points) <- f2017$driver

m <- mL2017   # maxp(L2017)
ox <- rank(-points) # negative because number 1 = largest number of points
oy <- rank(-m)      # negative because number 1 = largest strength
par(pty='s')        # square plot
plot(ox,oy,asp=1,pty='s',xlim=c(0,25),ylim=c(0,25),pch=16,
xlab="official order",ylab="my order",main='Formula 1, 2017 season')
par(xpd=TRUE)       # allow drivers' names to appear outside plotting region
for(i in seq_along(ox)){text(ox[i],oy[i],names(ox)[i],pos=4,col='gray') }
par(xpd=FALSE)      # stop diagonal line from protruding beyond plotting region
abline(0,1)
```

In the graph above, we see a certain amount of disagreement.  For
example, using F1 points scored places Hamilton first (363), Vettel
second (317), and Bottas third (305); while `hyper2` places Hamilton
first (0.29), Bottas second (0.17), and Vettel third (0.14).  Note
also the large number of players with zero points (who rank equal 23rd
by the F1 points system) but are nevertheless separated by
Bradley-Terry.  These players appear as a line of points at $x=23$:
Resta to Ericcson.  Note also Palmer and Alonso who managed to score a
F1 point but rank below Ericcson according to Bradley-Terry.

But overall there
seems to be some degree of correlation between the two, and
differences in detail.

# Analysis of nulls:

## Null of equal strengths:

```{r,equalstrength}
L1 <- loglik(indep(equalp(L2017)),L2017)
L2 <- loglik(indep(mL2017),L2017)   # mL2017 == maxp(L2017)
pchisq(2*(L2-L1),df=25-1,lower.tail=FALSE)
```

highly signficant!

## Null of Hamilton being average

We can consider Hamilton and ask various questions about his playing
strength.  One natural null would be that Hamilton's strength is equal
to the mean strength, or $\frac{1}{25}$.  

* $H_2\colon p_\mathrm{Hamilton}\geq\frac{1}{25}$
* $H_3\colon p_\mathrm{Hamilton} < \frac{1}{25}$

Noting that the evaluate for Hamilton's strength
$\widehat{p_\mathrm{Hamilton}}$ is about 0.22, we may consider the
likelihood for $H_2$ to be equal to the unconstrained maximum
likelhood as in `L2` above.  The likelihood for $H_3$ requires a
constrained optimization:

```{r,constham}
small <- 0.01
L3 <- maxp(L2017, startp=c(small, rep((1-small)/24,23)),fcm=rbind(c(-1,rep(0,23))),fcv=-1/25,give=TRUE)
L3
```

(note that the constrained maximum attains the constraint of
$p_\mathrm{Hamilton}=\frac{1}{25}$).   The likelihood ratio test gives

```{r,liktestivediff}
L2 - L3$value 
```

or a p-value of 

```{r,liktestive}
pchisq(2*(L2 - L3$value),df=1,lower.tail=FALSE)
```

## Null of Hamilton being better than other players

We may now test

* $H_4\colon p_\mathrm{Hamilton} > \max_{i\neq\mathrm{Hamilton}} p_i$

This is quite difficult to evaluate formally but we can evaluate it with no loss in accuracy by observing that the second strongest competitor is Bottas and considering instead

* $H_4'\colon p_\mathrm{Hamilton} > p_\mathrm{Bottas}$.

```{r,L4like}
small <- 0.01
L4 <- maxp(L2017, startp=c(small, rep((1-small)/24,23)),fcm=rbind(c(-1,1,rep(0,22))),fcv=0,give=TRUE)
L4
```

Calculating the support and asymptotic p-values:
```{r,l4val}
L2 - L4$value 
pchisq(2*(L2 - L4$value),df=1,lower.tail=FALSE)
```

## All years data

We will consider four years data:

```{r,fouryearsdata}
F1_2014 <- "formula1_2014.txt" %>% read.table(header=TRUE) %>% ordertable2supp
F1_2015 <- "formula1_2015.txt" %>% read.table(header=TRUE) %>% ordertable2supp
F1_2016 <- "formula1_2016.txt" %>% read.table(header=TRUE) %>% ordertable2supp
F1_2017 <- "formula1_2017.txt" %>% read.table(header=TRUE) %>% ordertable2supp
a <- list(F1_2014, F1_2015, F1_2016, F1_2017)
alldrivers <- all_pnames(a)

F1_total <- hyper2(pnames=alldrivers)

F1_total %<>% add(change_pnames(F1_2014,alldrivers)) 
F1_total %<>% add(change_pnames(F1_2015,alldrivers)) 
F1_total %<>% add(change_pnames(F1_2016,alldrivers)) 
F1_total %<>% add(change_pnames(F1_2017,alldrivers)) 

mallyears <- maxp(F1_total)
```

and the plot:

```{r,allyearplot,fig.height=7}
dotchart(mallyears,pch=16,main='Formula 1, 2014-7')
```

We see that Hamilton has the highest estimated strength.


# Conditions

Taking 2017 as an example:

`
venue pole conditions\
AUS Hamilton   dry \
CHN Hamilton   wet \
BHR Bottas     dry \
RUS Vettel     dry \
ESP Hamilton   dry \
MON Raikkonen  dry \
CAN Hamilton   dry \
AZE Hamilton   dry \
AUT Bottas     dry \
GBR Hamilton   dry \
HUN Vettel     dry \
BEL Hamilton   dry \
ITA Hamilon    dry \
SIN Vettel     wet \
MAL Hamilton   dry \
JPN Hamilton   dry \
USA Hamilton   dry \
MEX Vettel     dry \
BRA Bottas     dry \
ABU Bottas     dry \
`
