---
title: "universities"
output: html_document
---

```{r setup, include=FALSE}
library("hyper2")
library("magrittr")
knitr::opts_chunk$set(echo = TRUE)
```

## University ranking data

First load the data:

```{r cars}
a <- read.table("universities.txt",header=TRUE)
head(a,12)
```

Each row corresponds to a ranking in the THE ranking system.  Thus the
first row refers to The University of Auckland 2012, and we see that
they scored 28.3 for their teaching, 25.0 for their research, and so
on; rows 3 and 4 show that AUT and Lincoln were not given rankings
that year.  Rows 1-8 give results for 2012, rows 9-16 give 2013, and
so on to 2020.

We can coerce each year to a `hyper2` likelihood function by
converting to an order table with `order()`, thence to a support function:

```{r, label=definehelperfunctionf}
f <- function(a,y){
  a <- subset(a,a$year==y)
  o <- function(v){  # 'v' is a character vector
    good <- v != "DNP"
    v[good] <- rank(-as.numeric(v[good]),ties.method="last")
    return(v)
  }
  out <- data.frame(o(a[,3]),o(a[,4]),o(a[,5]),o(a[,6]),o(a[,7]))
  colnames(out) <- colnames(a)[3:7]
  rownames(out) <- a[,1]
  return(out)
}
f(a,2012)
```

Now:
```{r,playerwithadvantage}
H <- hyper2(pnames=a[1:8,1])
for(i in 2013:2020){ H %<>% `+`(ordertable2supp(f(a,i)))}
H
```

Object `H` is simply the support function for the universities'
strengths for all years' observations (assumed to be independent)
2013-2020:

```{r,label=maxpcalc,cache=TRUE}
m <- maxp(H)
m
pie(m)
```

Note the dominance of Auckland (UoA).  We observe that AUT has
increased its strength since 2016 and we can test whether this
increase is significant:


```{r,label=preandpost}

H1 <- hyper2(pnames=c("AUT_pre",a[c(1:2,4:8),1]))
for(i in 2012:2016){
  b <- f(a,i)
  rownames(b)[3] <- "AUT_pre"
  H1 <- combine(H1,ordertable2supp(b))
} # column loop closes


H2 <- hyper2(pnames=c("AUT_post",a[c(1:2,4:8),1]))
for(i in 2017:2020){
  jj <- f(a,i)
  rownames(jj)[3] <- "AUT_post"
  H2 <- combine(H2,ordertable2supp(jj))
}
maxp(H2)
```


See how we reject $H_0\colon S=0$ with a p-value of about 0.00676,
significant at 1\%.

```{r}
H <- combine(H1,H2)
maxp(H)
samep.test(H,c(1,9))
```
